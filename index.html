const GITHUB_USERNAME = "yong0405";  // GitHub 사용자 이름
const REPO_NAME = "nas-folder-tree";  // 저장소 이름
const FILE_PATH = "data.json";  // 저장할 JSON 파일
const GITHUB_TOKEN = "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";  // Personal Access Token

async function saveTreeToGitHub() {
    const treeData = document.getElementById("data").innerHTML;  // 현재 폴더 트리 구조 저장
    const apiUrl = `https://api.github.com/repos/${GITHUB_USERNAME}/${REPO_NAME}/contents/${FILE_PATH}`;

    // 기존 파일의 SHA 값 가져오기 (파일이 없으면 null)
    let sha = null;
    const response = await fetch(apiUrl, {
        headers: {
            Authorization: `token ${GITHUB_TOKEN}`,
            Accept: "application/vnd.github.v3+json",
        },
    });

    if (response.ok) {
        const data = await response.json();
        sha = data.sha;
    }

    // JSON 데이터 변환 후 Base64 인코딩
    const content = btoa(unescape(encodeURIComponent(JSON.stringify({ tree: treeData }, null, 2))));

    // GitHub에 파일 저장 (업데이트 or 새 파일 생성)
    const updateResponse = await fetch(apiUrl, {
        method: "PUT",
        headers: {
            Authorization: `token ${GITHUB_TOKEN}`,
            Accept: "application/vnd.github.v3+json",
        },
        body: JSON.stringify({
            message: "자동 저장: 폴더 트리 업데이트",
            content: content,
            sha: sha,  // 기존 파일이 있으면 SHA 값 필요
        }),
    });

    if (updateResponse.ok) {
        console.log("GitHub에 저장 완료!");
    } else {
        console.error("저장 실패:", updateResponse.statusText);
    }
}

// 폴더 트리 변경될 때 자동 저장
function saveTree() {
    saveTreeToGitHub();  // GitHub에 저장
}

// 페이지 로드 시 GitHub에서 데이터 불러오기
async function loadTreeFromGitHub() {
    const apiUrl = `https://raw.githubusercontent.com/${GITHUB_USERNAME}/${REPO_NAME}/main/${FILE_PATH}`;
    const response = await fetch(apiUrl);

    if (response.ok) {
        const data = await response.json();
        document.getElementById("folderTree").innerHTML = data.tree;
    }
}

// 페이지 로드 시 실행
window.onload = function() {
    loadTreeFromGitHub();
};
